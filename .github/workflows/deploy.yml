name: Déploiement Continu du Portfolio (React & Symfony)

# Déclenche le workflow à chaque push sur la branche 'main'
# Vous pouvez ajuster cela si votre branche de déploiement est différente
on:
  push:
    branches:
      - main

jobs:
  # Job pour le déploiement du Front-end (React)
  deploy-frontend:
    runs-on: ubuntu-latest # Utilise un runner GitHub hébergé sur Ubuntu

    steps:
      - name: 🗂️ Checkout du code du dépôt
        uses: actions/checkout@v4 # Action pour récupérer le code de votre dépôt GitHub

      - name: 🟢 Configuration de Node.js
        uses: actions/setup-node@v4 # Action pour installer Node.js
        with:
          node-version: '20' # Utilisez une version LTS stable de Node.js, par exemple '20' ou '22'
          cache: 'npm' # Active la mise en cache des dépendances npm pour des builds plus rapides
          cache-dependency-path: projet-1/package-lock.json # Chemin vers votre fichier lock pour le cache

      - name: 📦 Installation des dépendances du Front-end (React)
        working-directory: ./projet-1 # Navigue vers le dossier de votre application React
        run: npm install # Exécute npm install pour installer les dépendances

      - name: 🏗️ Construction du Front-end (React)
        working-directory: ./projet-1 # S'assure d'être dans le bon répertoire pour le build
        run: npm run build # Exécute la commande de build de React (crée le dossier 'build')

      - name: 🚀 Déploiement du Front-end vers Hostinger via FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }} # L'adresse de votre serveur Hostinger
          user: ${{ secrets.FTP_USERNAME }} # Votre nom d'utilisateur Hostinger
          password: ${{ secrets.FTP_PASSWORD }} # Votre mot de passe Hostinger
          localDir: 'projet-1/build' # Le dossier local à transférer
          remoteDir: '/public_html' # Le dossier cible sur Hostinger

  # Job pour le déploiement du Back-end (Symfony) via FTP
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-frontend # Ce job ne commencera qu'après que 'deploy-frontend' soit terminé avec succès

    steps:
      - name: 🗂️ Checkout du code du dépôt
        uses: actions/checkout@v4

      - name: 🐘 Configuration de PHP et Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_mysql, zip, gd
          tools: composer:v2

      - name: 📦 Installation des dépendances Symfony
        working-directory: ./be/app
        run: composer install --no-dev --optimize-autoloader

      - name: 🧹 Nettoyage du cache et préparation
        working-directory: ./be/app
        run: |
          php bin/console cache:clear --env=prod
          chmod -R 755 var/

      - name: 🚀 Déploiement du Back-end vers Hostinger via FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: 'be/app'
          remoteDir: '/public_html/api'
