name: DÃ©ploiement Continu du Portfolio (React & Symfony)

# DÃ©clenche le workflow Ã  chaque push sur la branche 'main'
# Vous pouvez ajuster cela si votre branche de dÃ©ploiement est diffÃ©rente
on:
  push:
    branches:
      - main

jobs:
  # Job pour le dÃ©ploiement du Front-end (React)
  deploy-frontend:
    runs-on: ubuntu-latest # Utilise un runner GitHub hÃ©bergÃ© sur Ubuntu

    steps:
      - name: ğŸ—‚ï¸ Checkout du code du dÃ©pÃ´t
        uses: actions/checkout@v4 # Action pour rÃ©cupÃ©rer le code de votre dÃ©pÃ´t GitHub

      - name: ğŸŸ¢ Configuration de Node.js
        uses: actions/setup-node@v4 # Action pour installer Node.js
        with:
          node-version: '20' # Utilisez une version LTS stable de Node.js, par exemple '20' ou '22'
          cache: 'npm' # Active la mise en cache des dÃ©pendances npm pour des builds plus rapides
          cache-dependency-path: projet-1/package-lock.json # Chemin vers votre fichier lock pour le cache

      - name: ğŸ“¦ Installation des dÃ©pendances du Front-end (React)
        working-directory: ./projet-1 # Navigue vers le dossier de votre application React
        run: npm install # ExÃ©cute npm install pour installer les dÃ©pendances

      - name: ğŸ—ï¸ Construction du Front-end (React)
        working-directory: ./projet-1 # S'assure d'Ãªtre dans le bon rÃ©pertoire pour le build
        run: npm run build # ExÃ©cute la commande de build de React (crÃ©e le dossier 'build')

      - name: ğŸš€ DÃ©ploiement du Front-end vers Hostinger via FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }} # L'adresse de votre serveur Hostinger
          user: ${{ secrets.FTP_USERNAME }} # Votre nom d'utilisateur Hostinger
          password: ${{ secrets.FTP_PASSWORD }} # Votre mot de passe Hostinger
          localDir: 'projet-1/build' # Le dossier local Ã  transfÃ©rer
          remoteDir: '/public_html' # Le dossier cible sur Hostinger

  # Job pour le dÃ©ploiement du Back-end (Symfony) via FTP
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-frontend # Ce job ne commencera qu'aprÃ¨s que 'deploy-frontend' soit terminÃ© avec succÃ¨s

    steps:
      - name: ğŸ—‚ï¸ Checkout du code du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ˜ Configuration de PHP et Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_mysql, zip, gd
          tools: composer:v2

      - name: ğŸ“¦ Installation des dÃ©pendances Symfony
        working-directory: ./be/app
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸ§¹ Nettoyage du cache et prÃ©paration
        working-directory: ./be/app
        run: |
          php bin/console cache:clear --env=prod
          chmod -R 755 var/

      - name: ğŸš€ DÃ©ploiement du Back-end vers Hostinger via FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: 'be/app'
          remoteDir: '/public_html/api'
